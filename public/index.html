<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WebRTC Video Conference</title>
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        overflow-x: hidden;
      }

      #room-selection-container {
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(20px);
        padding: 3.5rem 3rem;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05);
        max-width: 480px;
        width: 90%;
        text-align: center;
        animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #room-selection-container h1 {
        color: #ffffff;
        font-size: 2.25rem;
        margin-bottom: 0.75rem;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      #room-selection-container label {
        display: block;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.95rem;
        margin-bottom: 2rem;
        line-height: 1.6;
        font-weight: 400;
      }

      #room-input {
        width: 100%;
        padding: 1.1rem 1.5rem;
        font-size: 1rem;
        background: rgba(0, 0, 0, 0.4);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        font-weight: 400;
      }

      #room-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      #room-input:focus {
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.6);
        transform: translateY(-1px);
      }

      #connect-button {
        width: 100%;
        padding: 1.1rem 2rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #000000;
        background: #ffffff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15);
      }

      #connect-button:hover {
        background: #f5f5f5;
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(255, 255, 255, 0.25);
      }

      #connect-button:active {
        transform: translateY(0);
      }

      #video-chat-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #000;
        display: none;
      }

      #remote-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #0a0a0a;
      }

      #local-video {
        position: absolute;
        bottom: 110px;
        right: 24px;
        width: 300px;
        height: 225px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.8);
        object-fit: cover;
        z-index: 10;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #0a0a0a;
      }

      .controls-container {
        position: absolute;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        z-index: 20;
        background: rgba(20, 20, 20, 0.85);
        padding: 16px 24px;
        border-radius: 60px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      }

      .control-btn {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        position: relative;
        -webkit-tap-highlight-color: transparent;
      }

      .control-btn svg {
        width: 22px;
        height: 22px;
        transition: all 0.3s ease;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: scale(1.08);
      }

      .control-btn:active {
        transform: scale(0.96);
      }

      .control-btn.active {
        background: rgba(255, 255, 255, 0.95);
        color: #000000;
      }

      .control-btn.end-call {
        background: #ef4444;
        color: #ffffff;
        width: 56px;
        height: 56px;
      }

      .control-btn.end-call:hover {
        background: #dc2626;
        transform: scale(1.08);
      }

      .control-btn.disabled {
        background: rgba(239, 68, 68, 0.9);
      }

      .participant-info {
        position: absolute;
        top: 24px;
        left: 24px;
        background: rgba(20, 20, 20, 0.85);
        padding: 14px 22px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        z-index: 15;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }

      .participant-info p {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        margin: 0;
        font-weight: 500;
        letter-spacing: 0.3px;
      }

      .participant-info .room-id {
        color: #ffffff;
        font-weight: 600;
      }

      .video-label {
        background: rgba(0, 0, 0, 0.75);
        color: #ffffff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        backdrop-filter: blur(10px);
        letter-spacing: 0.3px;
      }

      #local-video-label {
        position: absolute;
        bottom: 120px;
        right: 36px;
        z-index: 11;
      }

      .video-off-placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: rgba(255, 255, 255, 0.3);
        display: none;
      }

      .video-off-placeholder.active {
        display: block;
      }

      .video-off-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        opacity: 0.3;
      }

      .video-off-placeholder p {
        font-size: 0.95rem;
        font-weight: 500;
        letter-spacing: 0.3px;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        #room-selection-container {
          padding: 2rem 1.5rem;
          width: 92%;
          border-radius: 20px;
        }

        #room-selection-container h1 {
          font-size: 1.65rem;
          margin-bottom: 0.5rem;
        }

        #room-selection-container label {
          font-size: 0.88rem;
          margin-bottom: 1.5rem;
        }

        #room-input {
          padding: 0.95rem 1.2rem;
          font-size: 0.95rem;
          margin-bottom: 1.2rem;
        }

        #connect-button {
          padding: 0.95rem 1.5rem;
          font-size: 0.88rem;
        }

        .participant-info {
          top: 12px;
          left: 12px;
          padding: 10px 16px;
          border-radius: 10px;
        }

        .participant-info p {
          font-size: 0.75rem;
        }

        #local-video {
          width: 120px;
          height: 90px;
          bottom: 100px;
          right: 12px;
          border-radius: 12px;
        }

        #local-video-label {
          bottom: 108px;
          right: 20px;
          font-size: 0.65rem;
          padding: 4px 8px;
        }

        .controls-container {
          bottom: 20px;
          gap: 10px;
          padding: 12px 18px;
          border-radius: 50px;
          width: auto;
          max-width: calc(100% - 24px);
        }

        .control-btn {
          width: 46px;
          height: 46px;
          flex-shrink: 0;
        }

        .control-btn svg {
          width: 19px;
          height: 19px;
        }

        .control-btn.end-call {
          width: 50px;
          height: 50px;
        }

        .video-off-icon {
          width: 48px;
          height: 48px;
        }

        .video-off-placeholder p {
          font-size: 0.85rem;
          padding: 0 20px;
        }
      }

      /* Extra small phones */
      @media (max-width: 390px) {
        #room-selection-container {
          padding: 1.75rem 1.25rem;
        }

        #room-selection-container h1 {
          font-size: 1.5rem;
        }

        #local-video {
          width: 100px;
          height: 75px;
          bottom: 95px;
          right: 10px;
          border-radius: 10px;
        }

        #local-video-label {
          bottom: 103px;
          right: 16px;
          font-size: 0.6rem;
          padding: 3px 7px;
        }

        .controls-container {
          gap: 8px;
          padding: 10px 14px;
        }

        .control-btn {
          width: 42px;
          height: 42px;
        }

        .control-btn svg {
          width: 18px;
          height: 18px;
        }

        .control-btn.end-call {
          width: 46px;
          height: 46px;
        }

        .participant-info {
          top: 10px;
          left: 10px;
          padding: 8px 14px;
        }

        .participant-info p {
          font-size: 0.7rem;
        }
      }

      /* Landscape mode on mobile */
      @media (max-height: 500px) and (orientation: landscape) {
        #local-video {
          width: 140px;
          height: 105px;
          bottom: 70px;
          right: 12px;
        }

        #local-video-label {
          bottom: 78px;
          right: 20px;
        }

        .controls-container {
          bottom: 12px;
          padding: 10px 16px;
        }

        .participant-info {
          top: 8px;
          left: 8px;
          padding: 8px 14px;
        }
      }
    </style>
  </head>
  <body>
    <div id="room-selection-container">
      <h1>Video Conference</h1>
      <label>Enter room ID to join the conference</label>
      <input id="room-input" type="text" placeholder="meeting-room-123" />
      <button id="connect-button">Connect</button>
    </div>

    <div id="video-chat-container">
      <div class="participant-info">
        <p>Room: <span class="room-id" id="room-id-display"></span></p>
      </div>

      <video id="remote-video" autoplay="autoplay" playsinline></video>
      <div class="video-off-placeholder" id="remote-placeholder">
        <svg class="video-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"/>
          <line x1="1" y1="1" x2="23" y2="23"/>
        </svg>
        <p>Waiting for participant...</p>
      </div>

      <video id="local-video" autoplay="autoplay" muted="muted" playsinline></video>
      <div class="video-label" id="local-video-label">You</div>

      <div class="controls-container">
        <button class="control-btn active" id="mic-btn" title="Toggle Microphone">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
        <button class="control-btn active" id="camera-btn" title="Toggle Camera">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 7l-7 5 7 5V7z"></path>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
          </svg>
        </button>
        <button class="control-btn end-call" id="end-call-btn" title="End Call">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            <line x1="18" y1="6" x2="6" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      const roomSelectionContainer = document.getElementById('room-selection-container')
      const roomInput = document.getElementById('room-input')
      const connectButton = document.getElementById('connect-button')

      const videoChatContainer = document.getElementById('video-chat-container')
      const localVideoComponent = document.getElementById('local-video')
      const remoteVideoComponent = document.getElementById('remote-video')
      const roomIdDisplay = document.getElementById('room-id-display')

      const micBtn = document.getElementById('mic-btn')
      const cameraBtn = document.getElementById('camera-btn')
      const endCallBtn = document.getElementById('end-call-btn')

      const socket = io()
      const mediaConstraints = {
        audio: true,
        video: { width: 1280, height: 720 },
      }
      let localStream
      let remoteStream
      let isRoomCreator
      let rtcPeerConnection
      let roomId
      let isMicOn = true
      let isCameraOn = true

      const iceServers = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
          { urls: 'stun:stun3.l.google.com:19302' },
          { urls: 'stun:stun4.l.google.com:19302' },
        ],
      }

      const micOnIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
        <line x1="12" y1="19" x2="12" y2="23"></line>
        <line x1="8" y1="23" x2="16" y2="23"></line>
      </svg>`

      const micOffIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="1" y1="1" x2="23" y2="23"></line>
        <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
        <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
        <line x1="12" y1="19" x2="12" y2="23"></line>
        <line x1="8" y1="23" x2="16" y2="23"></line>
      </svg>`

      const cameraOnIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 7l-7 5 7 5V7z"></path>
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
      </svg>`

      const cameraOffIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"></path>
        <line x1="1" y1="1" x2="23" y2="23"></line>
      </svg>`

      connectButton.addEventListener('click', () => {
        joinRoom(roomInput.value)
      })

      roomInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          joinRoom(roomInput.value)
        }
      })

      micBtn.addEventListener('click', toggleMic)
      cameraBtn.addEventListener('click', toggleCamera)
      endCallBtn.addEventListener('click', endCall)

      socket.on('room_created', async () => {
        console.log('Socket event callback: room_created')

        await setLocalStream(mediaConstraints)
        isRoomCreator = true
      })

      socket.on('room_joined', async () => {
        console.log('Socket event callback: room_joined')

        await setLocalStream(mediaConstraints)
        socket.emit('start_call', roomId)
      })

      socket.on('full_room', () => {
        console.log('Socket event callback: full_room')

        alert('The room is full, please try another one')
      })

      socket.on('start_call', async () => {
        console.log('Socket event callback: start_call')

        if (isRoomCreator) {
          rtcPeerConnection = new RTCPeerConnection(iceServers)
          addLocalTracks(rtcPeerConnection)
          rtcPeerConnection.ontrack = setRemoteStream
          rtcPeerConnection.onicecandidate = sendIceCandidate
          await createOffer(rtcPeerConnection)
        }
      })

      socket.on('webrtc_offer', async (event) => {
        console.log('Socket event callback: webrtc_offer')

        if (!isRoomCreator) {
          rtcPeerConnection = new RTCPeerConnection(iceServers)
          addLocalTracks(rtcPeerConnection)
          rtcPeerConnection.ontrack = setRemoteStream
          rtcPeerConnection.onicecandidate = sendIceCandidate
          rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(event))
          await createAnswer(rtcPeerConnection)
        }
      })

      socket.on('webrtc_answer', (event) => {
        console.log('Socket event callback: webrtc_answer')

        rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(event))
      })

      socket.on('webrtc_ice_candidate', (event) => {
        console.log('Socket event callback: webrtc_ice_candidate')

        const candidate = new RTCIceCandidate({
          sdpMLineIndex: event.label,
          candidate: event.candidate,
        })
        rtcPeerConnection.addIceCandidate(candidate)
      })

      socket.on('user_left', () => {
        console.log('Socket event callback: user_left')
        
        remoteVideoComponent.srcObject = null
        
        alert('The other participant has left the call')
      })

      function toggleMic() {
        if (localStream) {
          isMicOn = !isMicOn
          localStream.getAudioTracks()[0].enabled = isMicOn
          
          if (isMicOn) {
            micBtn.classList.add('active')
            micBtn.classList.remove('disabled')
            micBtn.innerHTML = micOnIcon
          } else {
            micBtn.classList.remove('active')
            micBtn.classList.add('disabled')
            micBtn.innerHTML = micOffIcon
          }
        }
      }

      function toggleCamera() {
        if (localStream) {
          isCameraOn = !isCameraOn
          localStream.getVideoTracks()[0].enabled = isCameraOn
          
          if (isCameraOn) {
            cameraBtn.classList.add('active')
            cameraBtn.classList.remove('disabled')
            cameraBtn.innerHTML = cameraOnIcon
          } else {
            cameraBtn.classList.remove('active')
            cameraBtn.classList.add('disabled')
            cameraBtn.innerHTML = cameraOffIcon
          }
        }
      }

      function endCall() {
        if (roomId) {
          socket.emit('leave', roomId)
        }

        if (localStream) {
          localStream.getTracks().forEach(track => track.stop())
        }

        if (rtcPeerConnection) {
          rtcPeerConnection.close()
        }

        localVideoComponent.srcObject = null
        remoteVideoComponent.srcObject = null

        videoChatContainer.style.display = 'none'
        roomSelectionContainer.style.display = 'block'
        roomInput.value = ''

        localStream = null
        remoteStream = null
        rtcPeerConnection = null
        roomId = null
        isMicOn = true
        isCameraOn = true

        micBtn.classList.add('active')
        micBtn.classList.remove('disabled')
        micBtn.innerHTML = micOnIcon
        cameraBtn.classList.add('active')
        cameraBtn.classList.remove('disabled')
        cameraBtn.innerHTML = cameraOnIcon
      }

      function joinRoom(room) {
        if (room === '') {
          alert('Please type a room ID')
        } else {
          roomId = room
          roomIdDisplay.textContent = room
          socket.emit('join', room)
          showVideoConference()
        }
      }

      function showVideoConference() {
        roomSelectionContainer.style.display = 'none'
        videoChatContainer.style.display = 'block'
      }

      async function setLocalStream(mediaConstraints) {
        try {
          localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints)
          localVideoComponent.srcObject = localStream
        } catch (error) {
          console.error('Could not get user media', error)
          alert('Could not access camera/microphone. Please check permissions.')
        }
      }

      function addLocalTracks(rtcPeerConnection) {
        localStream.getTracks().forEach((track) => {
          rtcPeerConnection.addTrack(track, localStream)
        })
      }

      async function createOffer(rtcPeerConnection) {
        try {
          const sessionDescription = await rtcPeerConnection.createOffer()
          rtcPeerConnection.setLocalDescription(sessionDescription)
          
          socket.emit('webrtc_offer', {
            type: 'webrtc_offer',
            sdp: sessionDescription,
            roomId,
          })
        } catch (error) {
          console.error(error)
        }
      }

      async function createAnswer(rtcPeerConnection) {
        try {
          const sessionDescription = await rtcPeerConnection.createAnswer()
          rtcPeerConnection.setLocalDescription(sessionDescription)
          
          socket.emit('webrtc_answer', {
            type: 'webrtc_answer',
            sdp: sessionDescription,
            roomId,
          })
        } catch (error) {
          console.error(error)
        }
      }

      function setRemoteStream(event) {
        remoteVideoComponent.srcObject = event.streams[0]
        remoteStream = event.stream
      }

      function sendIceCandidate(event) {
        if (event.candidate) {
          socket.emit('webrtc_ice_candidate', {
            roomId,
            label: event.candidate.sdpMLineIndex,
            candidate: event.candidate.candidate,
          })
        }
      }
    </script>
  </body>
</html>